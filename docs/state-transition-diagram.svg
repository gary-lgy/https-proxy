<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1145px" preserveAspectRatio="none" style="width:2036px;height:1145px;background:#FFFFFF;" version="1.1" viewBox="0 0 2036 1145" width="2036px" zoomAndPan="magnify"><defs><filter height="300%" id="f1tzwxr9t5gph3" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="42.9766" rx="5" ry="5" style="stroke:#000000;stroke-width:1.0;" width="425" x="8" y="8"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="413" x="14" y="26.5352">We adopt the standard notation in state transition diagrams;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="353" x="14" y="43.0234">each state transition is labelled as 'event / reaction'.</text><!--MD5=[e8cf60533062ab1168b9330d662638e5]
cluster tunneling--><rect fill="#FEFECE" filter="url(#f1tzwxr9t5gph3)" height="647" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="819" x="7" y="486.9766"/><rect fill="#FFFFFF" height="510.582" rx="12.5" ry="12.5" style="stroke:#FFFFFF;stroke-width:1.0;" width="813" x="10" y="620.3945"/><line style="stroke:#A80036;stroke-width:1.5;" x1="7" x2="826" y1="617.3945" y2="617.3945"/><line style="stroke:#A80036;stroke-width:1.5;" x1="7" x2="826" y1="513.4648" y2="513.4648"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="90" y="504.5117">tunneling</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="383" x="12" y="527.5664">Receiving from client and sending to target share the same buffer.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="377" x="12" y="541.6992">We alternate between receiving from client and sending to target.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="0" x="16" y="555.832"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="383" x="12" y="569.9648">Receiving from target and sending to client share the same buffer.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="377" x="12" y="584.0977">We alternate between receiving from target and sending to client.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="0" x="16" y="598.2305"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="653" x="12" y="612.3633">However, receiving from and sending to the same host happens concurrently, because they use different buffers.</text><g id="tunneling.send_to_target_and_send_to_client"><rect fill="#FEFECE" filter="url(#f1tzwxr9t5gph3)" height="50" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="260" x="380" y="633.9766"/><line style="stroke:#A80036;stroke-width:1.5;" x1="380" x2="640" y1="660.4648" y2="660.4648"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="240" x="390" y="652.5117">send_to_target_and_send_to_client</text></g><g id="tunneling.send_to_target_and_receive_from_target"><rect fill="#FEFECE" filter="url(#f1tzwxr9t5gph3)" height="50" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="298" x="237" y="775.9766"/><line style="stroke:#A80036;stroke-width:1.5;" x1="237" x2="535" y1="802.4648" y2="802.4648"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="278" x="247" y="794.5117">send_to_target_and_receive_from_target</text></g><g id="tunneling.receive_from_client_and_send_to_client"><rect fill="#FEFECE" filter="url(#f1tzwxr9t5gph3)" height="50" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="290" x="96" y="1059.9766"/><line style="stroke:#A80036;stroke-width:1.5;" x1="96" x2="386" y1="1086.4648" y2="1086.4648"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="270" x="106" y="1078.5117">receive_from_client_and_send_to_client</text></g><g id="tunneling.receive_from_client_and_receive_from_target"><rect fill="#FEFECE" filter="url(#f1tzwxr9t5gph3)" height="50" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="328" x="165" y="917.9766"/><line style="stroke:#A80036;stroke-width:1.5;" x1="165" x2="493" y1="944.4648" y2="944.4648"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="308" x="175" y="936.5117">receive_from_client_and_receive_from_target</text></g><ellipse cx="1550" cy="75.9766" fill="#000000" filter="url(#f1tzwxr9t5gph3)" rx="10" ry="10" style="stroke:none;stroke-width:1.0;"/><g id="accepted"><rect fill="#FEFECE" filter="url(#f1tzwxr9t5gph3)" height="50.6211" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="200" x="1450" y="177.9766"/><line style="stroke:#A80036;stroke-width:1.5;" x1="1450" x2="1650" y1="204.4648" y2="204.4648"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="1519.5" y="196.5117">accepted</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="180" x="1455" y="221.0664">read HTTP CONNECT message</text></g><g id="connecting"><rect fill="#FEFECE" filter="url(#f1tzwxr9t5gph3)" height="64.7539" rx="12.5" ry="12.5" style="stroke:#A80036;stroke-width:1.5;" width="291" x="1200.5" y="320.9766"/><line style="stroke:#A80036;stroke-width:1.5;" x1="1200.5" x2="1491.5" y1="347.4648" y2="347.4648"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="76" x="1308" y="339.5117">connecting</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="267" x="1205.5" y="364.0664">resolve the target hostname to IP address and</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="230" x="1209.5" y="378.1992">try to establish TCP connection to target</text></g><ellipse cx="1346" cy="800.9766" filter="url(#f1tzwxr9t5gph3)" rx="10" ry="10" style="stroke:#000000;stroke-width:1.0;fill:none;"/><ellipse cx="1346.5" cy="801.4766" fill="#000000" rx="6" ry="6" style="stroke:none;stroke-width:1.0;"/><!--MD5=[e5609a6cce1cd3a9664f944443c75270]
link *start to accepted--><path d="M1550,86.0066 C1550,103.8866 1550,144.5266 1550,172.7366 " fill="none" id="*start-to-accepted" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1550,177.8466,1554,168.8466,1550,172.8466,1546,168.8466,1550,177.8466" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="1551" y="129.5449">incoming client connecton /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="41" x="1622" y="144.8555">accept</text><!--MD5=[c7cece667dbf2aa587436eaeeff5188e]
link accepted to connecting--><path d="M1515.85,229.2466 C1482.5,253.4466 1431.44,290.4966 1394,317.6466 " fill="none" id="accepted-to-connecting" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1389.51,320.9166,1399.1486,318.8923,1393.5641,317.9902,1394.4663,312.4057,1389.51,320.9166" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1473" y="272.5449">received valid CONNECT message /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="212" x="1478.5" y="287.8555">prepare to start target connection</text><!--MD5=[c80d2ccf554935d64daf6cf72cd3822a]
link accepted to *end--><path d="M1650.16,220.0666 C1671.54,228.1766 1691.68,240.4466 1705,258.9766 C1815.28,412.3366 1819.34,531.3866 1708,683.9766 C1664.77,743.2266 1423.67,787.0466 1360.93,797.5566 " fill="none" id="accepted-to-*end" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1355.74,798.4166,1365.2705,800.9004,1360.6735,797.6038,1363.9701,793.0068,1355.74,798.4166" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="238" x="1790" y="429.5449">received invalid CONNECT message ||</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="1828.5" y="444.8555">client connection closed /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="1836" y="460.166">close client connection</text><!--MD5=[9b22ae083a3552991478e4fc76f82837]
link connecting to *end--><path d="M1346,386.1566 C1346,474.9166 1346,723.6066 1346,785.7566 " fill="none" id="connecting-to-*end" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1346,790.8666,1350,781.8666,1346,785.8666,1342,781.8666,1346,790.8666" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="1458" y="649.0449">hostname blocked ||</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="1435.5" y="664.3555">failed to connect to target /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="352" x="1347" y="679.666">send 404 response to client and close client connection</text><!--MD5=[ca18d93646f3779eec2a3d298ca0398f]
link send_to_target_and_send_to_client to send_to_target_and_receive_from_target--><path d="M379.94,679.8266 C343.26,688.2266 310.25,699.4866 299,713.9766 C282.32,735.4666 304.11,756.9766 330.05,773.1166 " fill="none" id="send_to_target_and_send_to_client-to-send_to_target_and_receive_from_target" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="334.59,775.8566,328.9622,767.774,330.3127,773.2673,324.8194,774.6177,334.59,775.8566" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="336" y="727.5449">sent to client /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="300" y="742.8555">wait to receive from target</text><!--MD5=[44545705856b7fd2f931a7e54436bc1e]
link send_to_target_and_receive_from_target to send_to_target_and_send_to_client--><path d="M434.74,775.7366 C447.71,767.5966 460.91,757.5866 471,745.9766 C485.25,729.5766 495.2,707.1066 501.48,689.2466 " fill="none" id="send_to_target_and_receive_from_target-to-send_to_target_and_send_to_client" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="503.15,684.3366,496.4634,691.5677,501.539,689.0699,504.0368,694.1454,503.15,684.3366" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="491" y="727.5449">received from target /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="493.5" y="742.8555">wait to send to client</text><!--MD5=[0f3bab25d7f5a2cad6b3d7ee48009075]
link send_to_target_and_send_to_client to receive_from_client_and_send_to_client--><path d="M379.97,678.0166 C277.96,700.1766 144.42,749.0266 90,855.9766 C50.97,932.6866 142.93,1015.0766 199.94,1056.6466 " fill="none" id="send_to_target_and_send_to_client-to-receive_from_client_and_send_to_client" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="204.32,1059.8166,199.3637,1051.3057,200.2659,1056.8902,194.6814,1057.7923,204.32,1059.8166" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="125" y="869.5449">sent to target /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="91" y="884.8555">wait to receive from client</text><!--MD5=[91b9d826a730564d6d9a6dd4d7fd2e3b]
link receive_from_client_and_send_to_client to send_to_target_and_send_to_client--><path d="M386.13,1069.5766 C445.79,1061.0866 506.22,1048.3266 529,1029.9766 C644.69,936.7666 720.13,837.7766 638,713.9766 C630.46,702.6066 620,693.6266 608.29,686.5366 " fill="none" id="receive_from_client_and_send_to_client-to-send_to_target_and_send_to_client" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="603.92,684.0066,609.713,691.9716,608.2497,686.5072,613.7141,685.044,603.92,684.0066" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136" x="668" y="869.5449">received from client /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="668.5" y="884.8555">wait to send to target</text><!--MD5=[e9d76f27cee4c9592867e82e950d3b46]
link send_to_target_and_receive_from_target to receive_from_client_and_receive_from_target--><path d="M302.35,826.0066 C289.12,833.4866 277.14,843.2566 269,855.9766 C256.32,875.7966 271.73,897.5166 290.1,914.1766 " fill="none" id="send_to_target_and_receive_from_target-to-receive_from_client_and_receive_from_target" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="294.31,917.8666,290.1708,908.9297,290.5471,914.574,284.9028,914.9503,294.31,917.8666" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="304" y="869.5449">sent to target /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="270" y="884.8555">wait to receive from client</text><!--MD5=[fd96ec0814d0acc3adbb0a89359fc16a]
link receive_from_client_and_receive_from_target to send_to_target_and_receive_from_target--><path d="M406.35,917.8966 C419.33,910.3766 431.12,900.6166 439,887.9766 C451.07,868.6066 437.17,846.6966 420.58,829.8466 " fill="none" id="receive_from_client_and_receive_from_target-to-send_to_target_and_receive_from_target" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="416.78,826.1066,420.3895,835.2701,420.3439,829.6135,426.0006,829.5679,416.78,826.1066" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136" x="444" y="869.5449">received from client /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="444.5" y="884.8555">wait to send to target</text><!--MD5=[196c059b27d63f9118fb0911276d11da]
link receive_from_client_and_receive_from_target to receive_from_client_and_send_to_client--><path d="M237.87,968.0266 C224.47,975.4866 212.38,985.2366 204,997.9766 C192.23,1015.8866 202.39,1038.1466 215.02,1055.5466 " fill="none" id="receive_from_client_and_receive_from_target-to-receive_from_client_and_send_to_client" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="218.27,1059.8566,216.0316,1050.2654,215.254,1055.8686,209.6509,1055.091,218.27,1059.8566" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="205" y="1011.5449">received from target /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="207.5" y="1026.8555">wait to send to client</text><!--MD5=[2e9dade9735ba7678db337d5d295a8c0]
link receive_from_client_and_send_to_client to receive_from_client_and_receive_from_target--><path d="M315.74,1059.8466 C328.58,1052.3166 340.26,1042.5566 348,1029.9766 C358.55,1012.8366 353.23,990.5866 345.57,973.0166 " fill="none" id="receive_from_client_and_send_to_client-to-receive_from_client_and_receive_from_target" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="343.35,968.1866,343.47,978.0347,345.4362,972.7305,350.7404,974.6967,343.35,968.1866" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="390" y="1011.5449">sent to client /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="354" y="1026.8555">wait to receive from target</text><!--MD5=[4eaeec58eaabd1034c98fef5bf361edc]
link connecting to send_to_target_and_send_to_client--><path d="M1200.25,365.4366 C1022.46,381.0566 734.4,414.2766 644,470.9766 C582.75,509.3866 541.12,586.9866 521.99,629.1366 " fill="none" id="connecting-to-send_to_target_and_send_to_client" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="519.88,633.8466,527.2039,627.2617,521.92,629.2816,519.9,623.9977,519.88,633.8466" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="921.5" y="429.5449">target connected /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="270" x="847" y="444.8555">send 200 Connection Established to client;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="356" x="802" y="460.166">send any bytes read from client after CONNECT to target</text><!--MD5=[aec1bc9d83fa0a888b65e2c9853d747d]
link tunneling to *end--><path d="M826.1008,708.8742 C826.1503,709.0217 826.2002,709.1692 826.2503,709.3167 C826.3506,709.6116 826.4521,709.9064 826.5548,710.2012 C826.7602,710.7907 826.9706,711.3799 827.1861,711.9683 C827.6169,713.1451 828.068,714.3189 828.5402,715.487 C829.4847,717.8231 830.5138,720.1361 831.635,722.4034 C836.12,731.4728 842.08,739.8116 850,745.9766 C888.96,776.3066 1252.04,795.4466 1330.92,799.2666 " fill="none" id="tunneling-to-*end" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1336.1,799.5166,1327.2921,795.1097,1331.1052,799.2882,1326.9267,803.1014,1336.1,799.5166" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="468" x="851" y="727.5449">either client connection or target connection is closed by the other party /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="213" x="980.5" y="742.8555">close both connections gracefully</text><!--MD5=[075696ed6620973d94ac3f74c40d6301]
@startuml

legend top left
We adopt the standard notation in state transition diagrams;
each state transition is labelled as 'event / reaction'.
end legend

[*] - -> accepted : incoming client connecton /\n accept

accepted : read HTTP CONNECT message

accepted - -> connecting : received valid CONNECT message /\nprepare to start target connection
accepted - - -> [*] : received invalid CONNECT message ||\n client connection closed /\nclose client connection

connecting : resolve the target hostname to IP address and \n try to establish TCP connection to target

connecting - - -> [*] : hostname blocked ||\nfailed to connect to target /\nsend 404 response to client and close client connection

state tunneling {

    tunneling : Receiving from client and sending to target share the same buffer.
    tunneling : We alternate between receiving from client and sending to target.
    tunneling:
    tunneling : Receiving from target and sending to client share the same buffer.
    tunneling : We alternate between receiving from target and sending to client.
    tunneling :
    tunneling : However, receiving from and sending to the same host happens concurrently, because they use different buffers.

    send_to_target_and_send_to_client - -> send_to_target_and_receive_from_target : sent to client /\nwait to receive from target
    send_to_target_and_send_to_client - -> receive_from_client_and_send_to_client : sent to target /\nwait to receive from client

    send_to_target_and_receive_from_target - -> receive_from_client_and_receive_from_target : sent to target /\nwait to receive from client
    send_to_target_and_receive_from_target - -> send_to_target_and_send_to_client : received from target /\nwait to send to client

    receive_from_client_and_receive_from_target - -> send_to_target_and_receive_from_target : received from client /\nwait to send to target
    receive_from_client_and_receive_from_target - -> receive_from_client_and_send_to_client : received from target /\nwait to send to client

    receive_from_client_and_send_to_client - -> receive_from_client_and_receive_from_target: sent to client /\nwait to receive from target
    receive_from_client_and_send_to_client - -> send_to_target_and_send_to_client: received from client /\nwait to send to target

}

connecting - -> send_to_target_and_send_to_client : target connected /\n send 200 Connection Established to client;\nsend any bytes read from client after CONNECT to target

tunneling - -> [*] : either client connection or target connection is closed by the other party /\n close both connections gracefully

@enduml

PlantUML version 1.2021.11(Sat Oct 02 21:26:11 SGT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: GB
--></g></svg>