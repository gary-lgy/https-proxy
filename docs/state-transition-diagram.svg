<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="478.2px" preserveAspectRatio="none" style="width:1026px;height:478px;background:#FFFFFF;" version="1.1" viewBox="0 0 1026 478" width="1026.6px" zoomAndPan="magnify"><defs><filter height="300%" id="fm63lvs8cu49u" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="1.2"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="2.4" dy="2.4" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[e8cf60533062ab1168b9330d662638e5]
cluster tunneling--><rect fill="#FEFECE" filter="url(#fm63lvs8cu49u)" height="382.8" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.8999999999999999;" width="436.2" x="404.4" y="4.2"/><rect fill="#FFFFFF" height="326.3883" rx="7.5" ry="7.5" style="stroke:#FFFFFF;stroke-width:0.6;" width="432.6" x="406.2" y="58.8117"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="404.4" x2="840.6" y1="57.0117" y2="57.0117"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="404.4" x2="840.6" y1="20.093" y2="20.093"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="39.6" x="524.7" y="14.7211">tunneling</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="195.6" x="407.4" y="28.5539">reading from cc and writing to tc shares the same buffer</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="195.6" x="407.4" y="37.0336">reading from tc and writing to cc shares the same buffer</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="166.2" x="407.4" y="45.5133">if we're waiting to write to cc, don't read from tc</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="166.2" x="407.4" y="53.993">if we're waiting to write to tc, don't read from cc</text><g id="tunneling.tc_rw"><rect fill="#FEFECE" filter="url(#fm63lvs8cu49u)" height="30.3727" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.8999999999999999;" width="172.2" x="492.3" y="67.2"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="492.3" x2="664.5" y1="83.093" y2="83.093"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="21.6" x="567.6" y="78.3211">tc_rw</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="160.2" x="495.3" y="93.0539">epoll_wait on [tc (waiting to receive and send)]</text></g><g id="tunneling.cc_r_tc_r"><rect fill="#FEFECE" filter="url(#fm63lvs8cu49u)" height="30.3727" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.8999999999999999;" width="214.2" x="480.9" y="153"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="480.9" x2="695.1" y1="168.893" y2="168.893"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="35.4" x="570.3" y="164.1211">cc_r_tc_r</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="202.2" x="483.9" y="178.8539">epoll_wait on [cc(waiting to receive), tc (waiting to receive)]</text></g><g id="tunneling.cc_w_tc_w"><rect fill="#FEFECE" filter="url(#fm63lvs8cu49u)" height="30.3727" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.8999999999999999;" width="198.6" x="419.1" y="342"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="419.1" x2="617.7" y1="357.893" y2="357.893"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="41.4" x="497.7" y="353.1211">cc_w_tc_w</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="186.6" x="422.1" y="367.8539">epoll_wait on [cc(waiting to send), tc (waiting to send)]</text></g><g id="tunneling.cc_rw"><rect fill="#FEFECE" filter="url(#fm63lvs8cu49u)" height="30.3727" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.8999999999999999;" width="173.4" x="477.9" y="243"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="477.9" x2="651.3" y1="258.893" y2="258.893"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="22.8" x="553.2" y="254.1211">cc_rw</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="161.4" x="480.9" y="268.8539">epoll_wait on [cc (waiting to receive and send)]</text></g><ellipse cx="64.2" cy="82.5" fill="#000000" filter="url(#fm63lvs8cu49u)" rx="6" ry="6" style="stroke:none;stroke-width:0.6;"/><g id="accepted"><rect fill="#FEFECE" filter="url(#fm63lvs8cu49u)" height="30.3727" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.8999999999999999;" width="120" x="4.2" y="153"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="4.2" x2="124.2" y1="168.893" y2="168.893"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="36.6" x="45.9" y="164.1211">accepted</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="108" x="7.2" y="178.8539">read HTTP CONNECT message</text></g><g id="connecting"><rect fill="#FEFECE" filter="url(#fm63lvs8cu49u)" height="38.8523" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.8999999999999999;" width="174.6" x="117.3" y="238.8"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="117.3" x2="291.9" y1="254.693" y2="254.693"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="45.6" x="181.8" y="249.9211">connecting</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="160.2" x="120.3" y="264.6539">resolve the target hostname to IP address and</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="138" x="122.7" y="273.1336">try to establish TCP connection to target</text></g><ellipse cx="204.6" cy="426" filter="url(#fm63lvs8cu49u)" rx="6" ry="6" style="stroke:#000000;stroke-width:0.6;fill:none;"/><ellipse cx="204.9" cy="426.3" fill="#000000" rx="3.6" ry="3.6" style="stroke:none;stroke-width:0.6;"/><!--MD5=[e5609a6cce1cd3a9664f944443c75270]
link *start to accepted--><path d="M64.2,88.65 C64.2,100.896 64.2,130.68 64.2,149.988 " fill="none" id="*start-to-accepted" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="64.2,152.994,66.6,147.594,64.2,149.994,61.8,147.594,64.2,152.994" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="52.8" x="64.8" y="123.941">incoming cc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="35.4" x="74.7" y="133.1273">accept cc</text><!--MD5=[c7cece667dbf2aa587436eaeeff5188e]
link accepted to connecting--><path d="M87.54,183.666 C110.61,198.252 146.1,220.704 171.96,237.054 " fill="none" id="accepted-to-connecting" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="174.588,238.716,171.3046,233.8028,172.0517,237.1137,168.7409,237.8609,174.588,238.716" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="133.8" x="144" y="209.741">received valid CONNECT message /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="27" x="197.4" y="218.9273">start tc</text><!--MD5=[c80d2ccf554935d64daf6cf72cd3822a]
link accepted to *end--><path d="M58.656,183.648 C48.78,212.526 31.35,277.752 55.8,324 C86.898,382.824 169.146,413.928 195.99,422.742 " fill="none" id="accepted-to-*end" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="198.984,423.708,194.5878,419.7591,196.1303,422.7825,193.107,424.325,198.984,423.708" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="142.8" x="56.4" y="303.941">received invalid CONNECT message ||</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="76.8" x="90.6" y="313.1273">cc closed by client /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="30.6" x="112.5" y="322.3137">close cc</text><!--MD5=[9b22ae083a3552991478e4fc76f82837]
link connecting to *end--><path d="M204.6,277.836 C204.6,313.89 204.6,391.092 204.6,416.844 " fill="none" id="connecting-to-*end" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="204.6,419.994,207,414.594,204.6,416.994,202.2,414.594,204.6,419.994" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="105" x="229.8" y="355.841">failed to connect to target /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="154.2" x="205.2" y="365.0273">send 404 response to client and close cc</text><!--MD5=[f43231d6eb4c16971912ee5b2b7f438a]
link tc_rw to cc_r_tc_r--><path d="M539.64,97.92 C532.356,102.522 525.69,108.396 521.4,115.8 C517.122,123.186 516.888,127.758 521.4,135 C525.552,141.66 531.492,147 538.146,151.278 " fill="none" id="tc_rw-to-cc_r_tc_r" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="540.828,152.922,537.475,148.056,538.2692,151.3559,534.9693,152.1501,540.828,152.922" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="42.6" x="543.6" y="123.941">sent to tc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="85.8" x="522" y="133.1273">wait to receive from cc</text><!--MD5=[4428c1322e23cc1a099bebe13dfae057]
link cc_r_tc_r to tc_rw--><path d="M601.362,152.79 C608.94,142.458 615.966,128.358 610.8,115.8 C608.424,110.022 604.47,104.718 600.132,100.146 " fill="none" id="cc_r_tc_r-to-tc_rw" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="597.978,97.962,600.0659,103.4902,600.0864,100.0961,603.4805,100.1167,597.978,97.962" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="69" x="612.6" y="123.941">received from cc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="66" x="614.1" y="133.1273">wait to send to tc</text><!--MD5=[b42f2a74911ad0d1a348098e63590620]
link tc_rw to cc_w_tc_w--><path d="M544.884,97.824 C534.36,102.978 522.912,109.152 513,115.8 C492.126,129.798 484.332,132.078 470.4,153 C457.782,171.954 457.848,179.124 454.2,201.6 C445.128,257.496 458.328,276.786 489.6,324 C493.152,329.364 497.526,334.776 501.78,339.612 " fill="none" id="tc_rw-to-cc_w_tc_w" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="503.856,341.934,502.0489,336.3078,501.8576,339.6965,498.4689,339.5052,503.856,341.934" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="67.8" x="454.8" y="209.741">received from tc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="67.2" x="455.1" y="218.9273">wait to send to cc</text><!--MD5=[9220513ff5ada1a62067df3928ffe9ae]
link cc_w_tc_w to tc_rw--><path d="M617.862,343.254 C640.632,338.382 660.624,332.034 669,324 C715.53,279.348 697.398,247.56 705.6,183.6 C709.572,152.604 710.904,135.924 687,115.8 C678.738,108.846 669.036,103.368 658.884,99.06 " fill="none" id="cc_w_tc_w-to-tc_rw" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="656.004,97.872,660.0835,102.1473,658.778,99.0142,661.9111,97.7088,656.004,97.872" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="43.8" x="724.8" y="209.741">sent to cc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="84.6" x="704.4" y="218.9273">wait to receive from tc</text><!--MD5=[6f70bdb54283637e828b9a914e2682b4]
link cc_r_tc_r to cc_rw--><path d="M549.24,183.72 C541.956,188.322 535.29,194.196 531,201.6 C523.374,214.77 532.95,229.53 543.798,240.606 " fill="none" id="cc_r_tc_r-to-cc_rw" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="545.982,242.772,543.8273,237.2695,543.8479,240.6636,540.4538,240.6841,545.982,242.772" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="67.8" x="531.6" y="209.741">received from tc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="67.2" x="531.9" y="218.9273">wait to send to cc</text><!--MD5=[866f797d1bf0a28ccbbe384663f129fd]
link cc_rw to cc_r_tc_r--><path d="M585.438,242.886 C592.164,236.88 598.806,229.338 602.4,220.8 C607.044,209.772 603.45,196.8 598.686,186.582 " fill="none" id="cc_rw-to-cc_r_tc_r" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="597.324,183.78,597.5245,189.6859,598.6347,186.4785,601.8421,187.5888,597.324,183.78" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="43.8" x="625.2" y="209.741">sent to cc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="84.6" x="604.8" y="218.9273">wait to receive from tc</text><!--MD5=[8b55405d6f924dfa9de157c44be31672]
link cc_w_tc_w to cc_rw--><path d="M555,341.952 C562.194,337.308 568.806,331.404 573,324 C581.184,309.558 577.338,290.478 572.502,276.714 " fill="none" id="cc_w_tc_w-to-cc_rw" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="571.458,273.858,571.0537,279.7535,572.486,276.6764,575.5631,278.1087,571.458,273.858" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="42.6" x="599.4" y="308.441">sent to tc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="85.8" x="577.8" y="317.6273">wait to receive from cc</text><!--MD5=[dd82bd7861c845e608a810b44161b998]
link cc_rw to cc_w_tc_w--><path d="M522.264,273.63 C512.634,279.06 503.604,286.29 498,295.8 C489.966,309.432 497.106,326.664 505.068,339.318 " fill="none" id="cc_rw-to-cc_w_tc_w" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="506.778,341.946,505.8487,336.1102,505.1436,339.4303,501.8236,338.7252,506.778,341.946" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="69" x="498.6" y="308.441">received from cc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="66" x="500.1" y="317.6273">wait to send to tc</text><!--MD5=[3e2edbfafcc8ceeae5e5c966bb4a4ec5]
link connecting to cc_w_tc_w--><path d="M211.86,277.86 C218.808,294.966 229.416,318.294 237.6,324 C245.088,329.22 338.754,339.42 415.878,347.046 " fill="none" id="connecting-to-cc_w_tc_w" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="419.076,347.364,413.9433,344.4357,416.0911,347.0638,413.4629,349.2116,419.076,347.364" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="55.2" x="308.4" y="303.941">tc connected /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="162" x="256.2" y="313.1273">send 200 Connection Established to client;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="193.2" x="240.6" y="322.3137">any bytes read from client after CONNECT to target</text><!--MD5=[aec1bc9d83fa0a888b65e2c9853d747d]
link tunneling to *end--><path d="M840.6514,94.8647 C840.686,94.9548 840.7208,95.0454 840.7556,95.1364 C840.8254,95.3184 840.8956,95.5021 840.9663,95.6875 C841.5314,97.1709 842.1247,98.763 842.7363,100.4515 C843.9595,103.8286 845.256,107.5914 846.5475,111.6413 C851.7135,127.8405 856.8,148.632 856.8,167.7 C856.8,167.7 856.8,167.7 856.8,357.9 C856.8,378.57 848.994,386.43 831,396.6 C774.906,428.298 286.86,426 213.75,425.472 " fill="none" id="tunneling-to-*end" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="210.582,425.448,215.9612,427.8942,213.5819,425.4737,216.0024,423.0944,210.582,425.448" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="164.4" x="857.4" y="256.841">either cc or tc is closed by the other party /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="56.4" x="912.6" y="266.0273">close cc and tc</text><rect fill="#DDDDDD" height="25.7859" rx="3" ry="3" style="stroke:#000000;stroke-width:0.6;" width="305.4" x="356.4" y="443.4"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="267" x="360" y="454.5211">cc (client connection) - TCP connection between client and proxy</text><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="298.2" x="360" y="464.4141">tc (target connection) - TCP connection between proxy and target server</text><!--MD5=[4f50f18416e0b06af21a1b24e3b2a9e8]
@startuml

legend
cc (client connection) - TCP connection between client and proxy
tc (target connection) - TCP connection between proxy and target server
end legend

[*] - -> accepted : incoming cc /\n accept cc

accepted : read HTTP CONNECT message

accepted - -> connecting : received valid CONNECT message /\nstart tc
accepted - -> [*] : received invalid CONNECT message ||\n cc closed by client /\nclose cc

connecting : resolve the target hostname to IP address and \n try to establish TCP connection to target

connecting - - -> [*] : failed to connect to target /\nsend 404 response to client and close cc

state tunneling {

    tunneling : reading from cc and writing to tc shares the same buffer
    tunneling : reading from tc and writing to cc shares the same buffer
    tunneling : if we're waiting to write to cc, don't read from tc
    tunneling : if we're waiting to write to tc, don't read from cc

    tc_rw : epoll_wait on [tc (waiting to receive and send)]
    cc_r_tc_r : epoll_wait on [cc(waiting to receive), tc (waiting to receive)]
    cc_w_tc_w : epoll_wait on [cc(waiting to send), tc (waiting to send)]
    cc_rw : epoll_wait on [cc (waiting to receive and send)]

    tc_rw - -> cc_r_tc_r : sent to tc /\nwait to receive from cc
    tc_rw - -> cc_w_tc_w : received from tc /\nwait to send to cc

    cc_r_tc_r - -> tc_rw : received from cc /\nwait to send to tc
    cc_r_tc_r - -> cc_rw : received from tc /\nwait to send to cc

    cc_w_tc_w - -> tc_rw : sent to cc /\nwait to receive from tc
    cc_w_tc_w - -> cc_rw : sent to tc /\nwait to receive from cc

    cc_rw - -> cc_r_tc_r: sent to cc /\nwait to receive from tc
    cc_rw - -> cc_w_tc_w: received from cc /\nwait to send to tc
}

connecting - -> cc_w_tc_w : tc connected /\n send 200 Connection Established to client;\n any bytes read from client after CONNECT to target

tunneling - -> [*] : either cc or tc is closed by the other party /\n close cc and tc

@enduml

PlantUML version 1.2021.11(Sat Oct 02 21:26:11 SGT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: GB
--></g></svg>