<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1738.8px" preserveAspectRatio="none" style="width:1747px;height:1738px;background:#FFFFFF;" version="1.1" viewBox="0 0 1747 1738" width="1747.2px" zoomAndPan="magnify"><defs><filter height="300%" id="f11jly0m5ecrdd" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.7999999999999994"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="5.599999999999999" dy="5.599999999999999" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[e8cf60533062ab1168b9330d662638e5]
cluster tunneling--><rect fill="#FEFECE" filter="url(#f11jly0m5ecrdd)" height="852.6" rx="17.5" ry="17.5" style="stroke:#A80036;stroke-width:2.0999999999999996;" width="886.2" x="844.9" y="778.4"/><rect fill="#FFFFFF" height="720.9727" rx="17.5" ry="17.5" style="stroke:#FFFFFF;stroke-width:1.3999999999999997;" width="877.8" x="849.1" y="905.8273"/><line style="stroke:#A80036;stroke-width:2.0999999999999996;" x1="844.9" x2="1731.1" y1="901.6273" y2="901.6273"/><line style="stroke:#A80036;stroke-width:2.0999999999999996;" x1="844.9" x2="1731.1" y1="815.4836" y2="815.4836"/><text fill="#000000" font-family="sans-serif" font-size="19.6" lengthAdjust="spacing" textLength="92.4" x="1059.8" y="802.9492">tunneling</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="456.4" x="851.9" y="835.2258">reading from cc and writing to tc shares the same buffer</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="456.4" x="851.9" y="855.0117">reading from tc and writing to cc shares the same buffer</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="387.8" x="851.9" y="874.7977">if we're waiting to write to cc, don't read from tc</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="387.8" x="851.9" y="894.5836">if we're waiting to write to tc, don't read from cc</text><g id="tunneling.tc_rw"><rect fill="#FEFECE" filter="url(#f11jly0m5ecrdd)" height="70.8695" rx="17.5" ry="17.5" style="stroke:#A80036;stroke-width:2.0999999999999996;" width="382.2" x="1005.2" y="925.4"/><line style="stroke:#A80036;stroke-width:2.0999999999999996;" x1="1005.2" x2="1387.4" y1="962.4836" y2="962.4836"/><text fill="#000000" font-family="sans-serif" font-size="19.6" lengthAdjust="spacing" textLength="50.4" x="1171.1" y="951.3492">tc_rw</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="354.2" x="1012.2" y="985.7258">epoll_wait on [tc (waiting to read and write)]</text></g><g id="tunneling.cc_r_tc_r"><rect fill="#FEFECE" filter="url(#f11jly0m5ecrdd)" height="70.8695" rx="17.5" ry="17.5" style="stroke:#A80036;stroke-width:2.0999999999999996;" width="460.6" x="1020.6" y="1125.6"/><line style="stroke:#A80036;stroke-width:2.0999999999999996;" x1="1020.6" x2="1481.2" y1="1162.6836" y2="1162.6836"/><text fill="#000000" font-family="sans-serif" font-size="19.6" lengthAdjust="spacing" textLength="82.6" x="1209.6" y="1151.5492">cc_r_tc_r</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="432.6" x="1027.6" y="1185.9258">epoll_wait on [cc(waiting to read), tc (waiting to read)]</text></g><g id="tunneling.cc_w_tc_w"><rect fill="#FEFECE" filter="url(#f11jly0m5ecrdd)" height="70.8695" rx="17.5" ry="17.5" style="stroke:#A80036;stroke-width:2.0999999999999996;" width="463.4" x="933.8" y="1526"/><line style="stroke:#A80036;stroke-width:2.0999999999999996;" x1="933.8" x2="1397.2" y1="1563.0836" y2="1563.0836"/><text fill="#000000" font-family="sans-serif" font-size="19.6" lengthAdjust="spacing" textLength="96.6" x="1117.2" y="1551.9492">cc_w_tc_w</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="435.4" x="940.8" y="1586.3258">epoll_wait on [cc(waiting to write), tc (waiting to write)]</text></g><g id="tunneling.cc_rw"><rect fill="#FEFECE" filter="url(#f11jly0m5ecrdd)" height="70.8695" rx="17.5" ry="17.5" style="stroke:#A80036;stroke-width:2.0999999999999996;" width="385" x="1058.4" y="1325.8"/><line style="stroke:#A80036;stroke-width:2.0999999999999996;" x1="1058.4" x2="1443.4" y1="1362.8836" y2="1362.8836"/><text fill="#000000" font-family="sans-serif" font-size="19.6" lengthAdjust="spacing" textLength="53.2" x="1224.3" y="1351.7492">cc_rw</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="357" x="1065.4" y="1386.1258">epoll_wait on [cc (waiting to read and write)]</text></g><ellipse cx="156.1" cy="22.4" fill="#000000" filter="url(#f11jly0m5ecrdd)" rx="14" ry="14" style="stroke:none;stroke-width:1.3999999999999997;"/><g id="accepted"><rect fill="#FEFECE" filter="url(#f11jly0m5ecrdd)" height="70.8695" rx="17.5" ry="17.5" style="stroke:#A80036;stroke-width:2.0999999999999996;" width="292.6" x="9.8" y="165.2"/><line style="stroke:#A80036;stroke-width:2.0999999999999996;" x1="9.8" x2="302.4" y1="202.2836" y2="202.2836"/><text fill="#000000" font-family="sans-serif" font-size="19.6" lengthAdjust="spacing" textLength="85.4" x="113.4" y="191.1492">accepted</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="264.6" x="16.8" y="225.5258">epoll_wait on [cc (for CONNECT)]</text></g><g id="connecting"><rect fill="#FEFECE" filter="url(#f11jly0m5ecrdd)" height="70.8695" rx="17.5" ry="17.5" style="stroke:#A80036;stroke-width:2.0999999999999996;" width="401.8" x="379.4" y="365.4"/><line style="stroke:#A80036;stroke-width:2.0999999999999996;" x1="379.4" x2="781.2" y1="402.4836" y2="402.4836"/><text fill="#000000" font-family="sans-serif" font-size="19.6" lengthAdjust="spacing" textLength="106.4" x="527.1" y="391.3492">connecting</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="373.8" x="386.4" y="425.7258">epoll_wait on [tc (for connection) cc (for close)]</text></g><ellipse cx="591.5" cy="961.1" filter="url(#f11jly0m5ecrdd)" rx="14" ry="14" style="stroke:#000000;stroke-width:1.3999999999999997;fill:none;"/><ellipse cx="592.2" cy="961.8" fill="#000000" rx="8.4" ry="8.4" style="stroke:none;stroke-width:1.3999999999999997;"/><g id="connected"><rect fill="#FEFECE" filter="url(#f11jly0m5ecrdd)" height="70.8695" rx="17.5" ry="17.5" style="stroke:#A80036;stroke-width:2.0999999999999996;" width="445.2" x="973.7" y="586.6"/><line style="stroke:#A80036;stroke-width:2.0999999999999996;" x1="973.7" x2="1418.9" y1="623.6836" y2="623.6836"/><text fill="#000000" font-family="sans-serif" font-size="19.6" lengthAdjust="spacing" textLength="99.4" x="1146.6" y="612.5492">connected</text><text fill="#000000" font-family="sans-serif" font-size="16.8" lengthAdjust="spacing" textLength="417.2" x="980.7" y="646.9258">epoll_wait on [cc (for writing 200) and tc (for close)]</text></g><!--MD5=[e5609a6cce1cd3a9664f944443c75270]
link *start to accepted--><path d="M156.1,36.442 C156.1,61.474 156.1,118.37 156.1,157.864 " fill="none" id="*start-to-accepted" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="156.1,165.018,161.7,152.418,156.1,158.018,150.5,152.418,156.1,165.018" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="123.2" x="157.5" y="97.3957">incoming cc /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="82.6" x="180.6" y="118.8305">accept cc</text><!--MD5=[c7cece667dbf2aa587436eaeeff5188e]
link accepted to connecting--><path d="M229.992,236.684 C305.494,271.824 422.366,326.214 500.08,362.376 " fill="none" id="accepted-to-connecting" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="506.548,365.372,497.4731,354.991,500.1976,362.4272,492.7614,365.1516,506.548,365.372" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="312.2" x="408.1" y="297.5957">received valid CONNECT message /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="63" x="532.7" y="319.0305">start tc</text><!--MD5=[c80d2ccf554935d64daf6cf72cd3822a]
link accepted to *end--><path d="M151.494,236.768 C144.508,300.734 136.626,440.762 184.1,544.6 C275.842,745.248 507.752,905.772 573.734,948.5 " fill="none" id="accepted-to-*end" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="579.936,952.49,572.3476,940.9776,574.0419,948.7138,566.3057,950.4081,579.936,952.49" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="333.2" x="185.5" y="497.7957">received invalid CONNECT message ||</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="98" x="305.9" y="519.2305">cc closed /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="71.4" x="316.4" y="540.6652">close cc</text><!--MD5=[9b22ae083a3552991478e4fc76f82837]
link connecting to *end--><path d="M565.726,437.01 C551.194,473.438 529.872,532.896 521.5,586.6 C500.234,723.086 560.714,886.172 583.338,940.814 " fill="none" id="connecting-to-*end" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="586.138,947.506,586.3943,933.72,583.4144,941.0576,576.0769,938.0777,586.138,947.506" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="92.4" x="522.9" y="618.8957">cc closed/</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="71.4" x="533.4" y="640.3305">close cc</text><!--MD5=[9b22ae083a3552991478e4fc76f82837]
link connecting to *end--><path d="M590.73,437.388 C601.118,474.124 616.35,533.82 622.3,586.6 C637.42,720.804 607.698,882.938 595.98,939.26 " fill="none" id="connecting-to-*end-1" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="594.384,946.792,602.4842,935.6337,595.8412,939.9453,591.5296,933.3023,594.384,946.792" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="245" x="626.5" y="618.8957">failed to connect to target /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="196" x="651" y="640.3305">send 404 and close cc</text><!--MD5=[171f9586bb7321f97d59c962b0299183]
link connecting to connected--><path d="M677.222,436.87 C790.342,476.966 976.64,543.018 1092.588,584.122 " fill="none" id="connecting-to-connected" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="1099.434,586.558,1089.4296,577.0694,1092.8364,584.2188,1085.687,587.6256,1099.434,586.558" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="113.4" x="980.7" y="518.7957">tc connected</text><!--MD5=[1b773ae45b1a18ba2a54878a71ea9ae0]
link connected to *end--><path d="M1020.222,658.07 C981.694,668.85 941.878,682.626 906.5,700 C772.562,765.786 645.862,899.024 605.094,944.272 " fill="none" id="connected-to-*end" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="600.138,949.816,612.7174,944.1699,604.8097,944.603,604.3766,936.6952,600.138,949.816" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="275.8" x="907.9" y="718.9957">writing 200 failed || tc closed /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="131.6" x="980" y="740.4305">close cc and tc</text><!--MD5=[f43231d6eb4c16971912ee5b2b7f438a]
link tc_rw to cc_r_tc_r--><path d="M1152.802,997.122 C1128.134,1021.16 1105.258,1054.032 1122.1,1083.6 C1130.738,1098.748 1143.688,1111.194 1158.108,1121.33 " fill="none" id="tc_rw-to-cc_r_tc_r" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="1163.918,1125.236,1156.5868,1113.5581,1158.1091,1121.33,1150.3372,1122.8523,1163.918,1125.236" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="110.6" x="1135.4" y="1057.7957">wrote to tc /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="134.4" x="1123.5" y="1079.2305">receive from cc</text><!--MD5=[4428c1322e23cc1a099bebe13dfae057]
link cc_r_tc_r to tc_rw--><path d="M1263.304,1125.418 C1270.248,1100.568 1275.582,1066.66 1264.9,1038.8 C1259.902,1025.752 1251.516,1013.53 1242.29,1002.862 " fill="none" id="cc_r_tc_r-to-tc_rw" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="1237.11,997.094,1241.4043,1010.1966,1241.8038,1002.2871,1249.7133,1002.6866,1237.11,997.094" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="161" x="1271.9" y="1057.7957">received from cc /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="89.6" x="1307.6" y="1079.2305">write to tc</text><!--MD5=[b42f2a74911ad0d1a348098e63590620]
link tc_rw to cc_w_tc_w--><path d="M1134.63,996.884 C1089.242,1025.444 1029.798,1070.272 996.1,1125.6 C969.318,1169.588 977.62,1187.774 972.3,1239 C970.242,1258.81 967.4,1264.508 972.3,1283.8 C996.856,1380.456 1074.234,1470.868 1123.29,1520.582 " fill="none" id="tc_rw-to-cc_w_tc_w" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="1128.54,1525.846,1123.6163,1512.9667,1123.6003,1520.8863,1115.6807,1520.8703,1128.54,1525.846" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="158.2" x="973.7" y="1257.9957">received from tc /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="92.4" x="1006.6" y="1279.4305">write to cc</text><!--MD5=[9220513ff5ada1a62067df3928ffe9ae]
link cc_w_tc_w to tc_rw--><path d="M1378.706,1525.902 C1421.882,1514.828 1458.66,1500.926 1473.5,1484 C1558.116,1387.484 1498.532,1325.156 1505.7,1197 C1507.478,1165.318 1515.178,1155.882 1505.7,1125.6 C1491.686,1080.8 1483.412,1066.492 1445.5,1038.8 C1423.1,1022.448 1397.13,1009.54 1370.6,999.376 " fill="none" id="cc_w_tc_w-to-tc_rw" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="1363.852,996.856,1373.7093,1006.4973,1370.4129,999.2963,1377.6138,995.9999,1363.852,996.856" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="113.4" x="1519" y="1257.9957">wrote to cc /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="131.6" x="1509.9" y="1279.4305">receive from tc</text><!--MD5=[6f70bdb54283637e828b9a914e2682b4]
link cc_r_tc_r to cc_rw--><path d="M1188.04,1197.154 C1173.382,1208.438 1159.676,1222.41 1151.5,1239 C1142.694,1256.864 1142.694,1265.936 1151.5,1283.8 C1158.528,1298.052 1169.644,1310.386 1181.922,1320.732 " fill="none" id="cc_r_tc_r-to-cc_rw" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="1188.04,1325.646,1181.7157,1313.3935,1182.5798,1321.2658,1174.7075,1322.1299,1188.04,1325.646" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="158.2" x="1152.9" y="1257.9957">received from tc /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="92.4" x="1185.8" y="1279.4305">write to cc</text><!--MD5=[866f797d1bf0a28ccbbe384663f129fd]
link cc_rw to cc_r_tc_r--><path d="M1290.534,1325.758 C1301.622,1313.732 1312.234,1299.326 1318.1,1283.8 C1325.128,1265.166 1325.128,1257.634 1318.1,1239 C1313.158,1225.896 1304.828,1213.604 1295.672,1202.852 " fill="none" id="cc_rw-to-cc_r_tc_r" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="1290.534,1197.042,1294.7195,1210.1798,1295.1845,1202.2739,1303.0905,1202.7389,1290.534,1197.042" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="113.4" x="1332.8" y="1257.9957">wrote to cc /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="131.6" x="1323.7" y="1279.4305">receive from tc</text><!--MD5=[8b55405d6f924dfa9de157c44be31672]
link cc_w_tc_w to cc_rw--><path d="M1274.196,1525.874 C1292.214,1515.29 1308.566,1501.626 1319.5,1484 C1336.076,1457.274 1318.072,1426.418 1296.358,1402.548 " fill="none" id="cc_w_tc_w-to-cc_rw" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="1291.374,1397.256,1295.9317,1410.2694,1296.1716,1402.3534,1304.0875,1402.5933,1291.374,1397.256" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="110.6" x="1338.4" y="1458.1957">wrote to tc /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="134.4" x="1326.5" y="1479.6305">receive from cc</text><!--MD5=[dd82bd7861c845e608a810b44161b998]
link cc_rw to cc_w_tc_w--><path d="M1182.608,1397.34 C1167.334,1408.498 1153.124,1422.414 1144.5,1439.2 C1131.844,1463.84 1137.43,1494.626 1145.998,1518.986 " fill="none" id="cc_rw-to-cc_w_tc_w" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="1148.476,1525.678,1149.3321,1511.9162,1146.0357,1519.1171,1138.8347,1515.8207,1148.476,1525.678" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="161" x="1145.9" y="1458.1957">received from cc /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="89.6" x="1181.6" y="1479.6305">write to tc</text><!--MD5=[a98136701e795c1e1676cc832b0201ed]
link connected to tc_rw--><path d="M1196.3,658.392 C1196.3,720.678 1196.3,851.186 1196.3,918.134 " fill="none" id="connected-to-tc_rw" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="1196.3,925.19,1201.9,912.59,1196.3,918.19,1190.7,912.59,1196.3,925.19" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="196" x="1288" y="718.9957">write 200 succeeded /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="376.6" x="1197.7" y="740.4305">send the bytes right after CONNECT, if any</text><!--MD5=[aec1bc9d83fa0a888b65e2c9853d747d]
link tunneling to *end--><path d="M844.4431,961.1 C838.6012,961.1 830.7917,961.1 821.5406,961.1 C803.0382,961.1 778.7692,961.1 752.941,961.1 C701.2845,961.1 643.391,961.1 612.92,961.1 " fill="none" id="tunneling-to-*end" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><polygon fill="#A80036" points="605.724,961.1,618.324,966.7,612.724,961.1,618.324,955.5,605.724,961.1" style="stroke:#A80036;stroke-width:1.3999999999999997;"/><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="198.8" x="631.148" y="931.0957">either cc or tc closes /</text><text fill="#000000" font-family="sans-serif" font-size="18.2" lengthAdjust="spacing" textLength="131.6" x="667.548" y="952.5305">close cc and tc</text><rect fill="#DDDDDD" height="60.1672" rx="7" ry="7" style="stroke:#000000;stroke-width:1.3999999999999997;" width="712.6" x="507.85" y="1657.6"/><text fill="#000000" font-family="sans-serif" font-size="19.6" lengthAdjust="spacing" textLength="623" x="516.25" y="1683.5492">cc (client connection) - TCP connection between client and proxy</text><text fill="#000000" font-family="sans-serif" font-size="19.6" lengthAdjust="spacing" textLength="695.8" x="516.25" y="1706.6328">tc (target connection) - TCP connection between proxy and target server</text><!--MD5=[0140df779b632f66146584243a17abff]
@startuml

legend
cc (client connection) - TCP connection between client and proxy
tc (target connection) - TCP connection between proxy and target server
end legend

[*] - -> accepted : incoming cc /\n accept cc

accepted : epoll_wait on [cc (for CONNECT)]

accepted - -> connecting : received valid CONNECT message /\nstart tc
accepted - -> [*] : received invalid CONNECT message ||\n cc closed /\nclose cc

connecting : epoll_wait on [tc (for connection) cc (for close)]

connecting - -> [*] : cc closed/\nclose cc
connecting - -> [*] : failed to connect to target /\nsend 404 and close cc

connecting - -> connected : tc connected

connected : epoll_wait on [cc (for writing 200) and tc (for close)]

connected - -> [*] : writing 200 failed || tc closed /\nclose cc and tc

state tunneling {

    tunneling : reading from cc and writing to tc shares the same buffer
    tunneling : reading from tc and writing to cc shares the same buffer
    tunneling : if we're waiting to write to cc, don't read from tc
    tunneling : if we're waiting to write to tc, don't read from cc

    tc_rw : epoll_wait on [tc (waiting to read and write)]
    cc_r_tc_r : epoll_wait on [cc(waiting to read), tc (waiting to read)]
    cc_w_tc_w : epoll_wait on [cc(waiting to write), tc (waiting to write)]
    cc_rw : epoll_wait on [cc (waiting to read and write)]

    tc_rw - -> cc_r_tc_r : wrote to tc /\nreceive from cc
    tc_rw - -> cc_w_tc_w : received from tc /\nwrite to cc

    cc_r_tc_r - -> tc_rw : received from cc /\nwrite to tc
    cc_r_tc_r - -> cc_rw : received from tc /\nwrite to cc

    cc_w_tc_w - -> tc_rw : wrote to cc /\nreceive from tc
    cc_w_tc_w - -> cc_rw : wrote to tc /\nreceive from cc

    cc_rw - -> cc_r_tc_r: wrote to cc /\nreceive from tc
    cc_rw - -> cc_w_tc_w: received from cc /\nwrite to tc
}

connected - -> tc_rw : write 200 succeeded /\nsend the bytes right after CONNECT, if any

tunneling -> [*] : either cc or tc closes /\n close cc and tc

@enduml

PlantUML version 1.2021.11(Sat Oct 02 21:26:11 SGT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: GB
--></g></svg>