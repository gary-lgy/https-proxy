<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="487.2px" preserveAspectRatio="none" style="width:1050px;height:487px;background:#FFFFFF;" version="1.1" viewBox="0 0 1050 487" width="1050.6px" zoomAndPan="magnify"><defs><filter height="300%" id="f1gwu2zdzzh600" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="1.2"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="2.4" dy="2.4" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[e8cf60533062ab1168b9330d662638e5]
cluster tunneling--><rect fill="#FEFECE" filter="url(#f1gwu2zdzzh600)" height="373.8" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.8999999999999999;" width="436.2" x="607.5" y="67.2"/><rect fill="#FFFFFF" height="317.3883" rx="7.5" ry="7.5" style="stroke:#FFFFFF;stroke-width:0.6;" width="432.6" x="609.3" y="121.8117"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="607.5" x2="1043.7" y1="120.0117" y2="120.0117"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="607.5" x2="1043.7" y1="83.093" y2="83.093"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="39.6" x="727.8" y="77.7211">tunneling</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="195.6" x="610.5" y="91.5539">reading from cc and writing to tc shares the same buffer</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="195.6" x="610.5" y="100.0336">reading from tc and writing to cc shares the same buffer</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="166.2" x="610.5" y="108.5133">if we're waiting to write to cc, don't read from tc</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="166.2" x="610.5" y="116.993">if we're waiting to write to tc, don't read from cc</text><g id="tunneling.tc_rw"><rect fill="#FEFECE" filter="url(#f1gwu2zdzzh600)" height="30.3727" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.8999999999999999;" width="172.2" x="681" y="130.2"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="681" x2="853.2" y1="146.093" y2="146.093"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="21.6" x="756.3" y="141.3211">tc_rw</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="160.2" x="684" y="156.0539">epoll_wait on [tc (waiting to receive and send)]</text></g><g id="tunneling.cc_r_tc_r"><rect fill="#FEFECE" filter="url(#f1gwu2zdzzh600)" height="30.3727" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.8999999999999999;" width="214.2" x="691.8" y="220.2"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="691.8" x2="906" y1="236.093" y2="236.093"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="35.4" x="781.2" y="231.3211">cc_r_tc_r</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="202.2" x="694.8" y="246.0539">epoll_wait on [cc(waiting to receive), tc (waiting to receive)]</text></g><g id="tunneling.cc_w_tc_w"><rect fill="#FEFECE" filter="url(#f1gwu2zdzzh600)" height="30.3727" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.8999999999999999;" width="198.6" x="627" y="396"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="627" x2="825.6" y1="411.893" y2="411.893"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="41.4" x="705.6" y="407.1211">cc_w_tc_w</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="186.6" x="630" y="421.8539">epoll_wait on [cc(waiting to send), tc (waiting to send)]</text></g><g id="tunneling.cc_rw"><rect fill="#FEFECE" filter="url(#f1gwu2zdzzh600)" height="30.3727" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.8999999999999999;" width="173.4" x="688.2" y="310.2"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="688.2" x2="861.6" y1="326.093" y2="326.093"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="22.8" x="763.5" y="321.3211">cc_rw</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="161.4" x="691.2" y="336.0539">epoll_wait on [cc (waiting to receive and send)]</text></g><ellipse cx="176.1" cy="9.6" fill="#000000" filter="url(#f1gwu2zdzzh600)" rx="6" ry="6" style="stroke:none;stroke-width:0.6;"/><g id="accepted"><rect fill="#FEFECE" filter="url(#f1gwu2zdzzh600)" height="30.3727" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.8999999999999999;" width="120" x="116.1" y="130.2"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="116.1" x2="236.1" y1="146.093" y2="146.093"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="36.6" x="157.8" y="141.3211">accepted</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="108" x="119.1" y="156.0539">read HTTP CONNECT message</text></g><g id="connecting"><rect fill="#FEFECE" filter="url(#f1gwu2zdzzh600)" height="38.8523" rx="7.5" ry="7.5" style="stroke:#A80036;stroke-width:0.8999999999999999;" width="174.6" x="4.2" y="216"/><line style="stroke:#A80036;stroke-width:0.8999999999999999;" x1="4.2" x2="178.8" y1="231.893" y2="231.893"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="45.6" x="68.7" y="227.1211">connecting</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="160.2" x="7.2" y="241.8539">resolve the target hostname to IP address and</text><text fill="#000000" font-family="sans-serif" font-size="7.2" lengthAdjust="spacing" textLength="138" x="9.6" y="250.3336">try to establish TCP connection to target</text></g><ellipse cx="280.5" cy="325.5" filter="url(#f1gwu2zdzzh600)" rx="6" ry="6" style="stroke:#000000;stroke-width:0.6;fill:none;"/><ellipse cx="280.8" cy="325.8" fill="#000000" rx="3.6" ry="3.6" style="stroke:none;stroke-width:0.6;"/><!--MD5=[e5609a6cce1cd3a9664f944443c75270]
link *start to accepted--><path d="M176.1,15.648 C176.1,34.302 176.1,96.156 176.1,127.038 " fill="none" id="*start-to-accepted" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="176.1,130.11,178.5,124.71,176.1,127.11,173.7,124.71,176.1,130.11" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="52.8" x="176.7" y="41.741">incoming cc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="35.4" x="186.6" y="50.9273">accept cc</text><!--MD5=[c7cece667dbf2aa587436eaeeff5188e]
link accepted to connecting--><path d="M133.896,160.806 C125.106,165.45 116.556,171.366 110.1,178.8 C101.856,188.286 97.242,201.54 94.674,212.778 " fill="none" id="accepted-to-connecting" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="94.002,215.892,97.4897,211.1217,94.6364,212.9599,92.7983,210.1066,94.002,215.892" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="133.8" x="110.7" y="186.941">received valid CONNECT message /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="27" x="164.1" y="196.1273">start tc</text><!--MD5=[c80d2ccf554935d64daf6cf72cd3822a]
link accepted to *end--><path d="M224.514,160.872 C233.19,165.42 241.398,171.282 247.5,178.8 C265.098,200.484 276.396,288.612 279.576,316.44 " fill="none" id="accepted-to-*end" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="279.924,319.524,281.7077,313.8903,279.5899,316.5427,276.9375,314.4249,279.924,319.524" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="142.8" x="271.5" y="229.541">received invalid CONNECT message ||</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="76.8" x="305.7" y="238.7273">cc closed by client /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="30.6" x="327.6" y="247.9137">close cc</text><!--MD5=[9b22ae083a3552991478e4fc76f82837]
link connecting to *end--><path d="M84.846,255.024 C81.9,267.126 80.838,282.342 89.7,292.2 C114.888,320.22 222.846,297.432 258.3,310.2 C263.988,312.252 269.664,316.044 273.852,319.266 " fill="none" id="connecting-to-*end" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="276.252,321.174,273.5205,315.9339,273.9044,319.3062,270.532,319.69,276.252,321.174" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="105" x="114.9" y="281.141">failed to connect to target /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="154.2" x="90.3" y="290.3273">send 404 response to client and close cc</text><!--MD5=[f43231d6eb4c16971912ee5b2b7f438a]
link tc_rw to cc_r_tc_r--><path d="M737.832,160.86 C731.286,165.642 725.196,171.606 721.5,178.8 C717.6,186.39 716.946,190.782 721.5,198 C727.008,206.73 735.21,213.432 744.24,218.574 " fill="none" id="tc_rw-to-cc_r_tc_r" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="747.066,220.122,743.4746,215.4292,744.4323,218.6854,741.1761,219.6431,747.066,220.122" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="42.6" x="743.7" y="186.941">sent to tc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="85.8" x="722.1" y="196.1273">wait to receive from cc</text><!--MD5=[4428c1322e23cc1a099bebe13dfae057]
link cc_r_tc_r to tc_rw--><path d="M807.144,220.17 C812.532,208.446 817.464,191.886 810.9,178.8 C807.774,172.566 802.83,167.214 797.376,162.756 " fill="none" id="cc_r_tc_r-to-tc_rw" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="795.012,160.896,797.7854,166.1141,797.3745,162.7449,800.7437,162.3341,795.012,160.896" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="69" x="814.5" y="186.941">received from cc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="66" x="816" y="196.1273">wait to send to tc</text><!--MD5=[b42f2a74911ad0d1a348098e63590620]
link tc_rw to cc_w_tc_w--><path d="M739.032,160.8 C730.32,165.954 720.954,172.134 713.1,178.8 C676.812,209.616 669.798,226.02 662.1,273 C654.336,320.358 661.026,337.842 687.3,378 C691.152,383.886 696.378,389.274 701.76,393.906 " fill="none" id="tc_rw-to-cc_w_tc_w" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="704.064,395.844,701.4715,390.5338,701.7664,393.915,698.3851,394.2099,704.064,395.844" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="67.8" x="662.7" y="281.141">received from tc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="67.2" x="663" y="290.3273">wait to send to cc</text><!--MD5=[9220513ff5ada1a62067df3928ffe9ae]
link cc_w_tc_w to tc_rw--><path d="M818.592,395.976 C839.982,391.08 858.942,385.05 867.3,378 C874.122,372.246 911.208,285.738 916.5,255 C922.614,219.504 918.684,199.062 888.9,178.8 C878.508,171.732 866.658,166.188 854.514,161.844 " fill="none" id="cc_w_tc_w-to-tc_rw" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="851.592,160.818,855.8944,164.8689,854.4232,161.8102,857.4819,160.339,851.592,160.818" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="43.8" x="932.7" y="281.141">sent to cc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="84.6" x="912.3" y="290.3273">wait to receive from tc</text><!--MD5=[6f70bdb54283637e828b9a914e2682b4]
link cc_r_tc_r to cc_rw--><path d="M761.922,250.872 C752.784,256.392 744.12,263.658 738.9,273 C734.736,280.446 735.444,284.394 738.9,292.2 C741.516,298.104 745.782,303.402 750.474,307.926 " fill="none" id="cc_r_tc_r-to-cc_rw" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="752.808,310.08,750.4653,304.6549,750.6026,308.0462,747.2113,308.1835,752.808,310.08" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="67.8" x="739.5" y="281.141">received from tc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="67.2" x="739.8" y="290.3273">wait to send to cc</text><!--MD5=[866f797d1bf0a28ccbbe384663f129fd]
link cc_rw to cc_r_tc_r--><path d="M796.44,310.182 C802.008,305.19 807.282,299.1 810.3,292.2 C815.664,279.948 812.238,265.068 807.78,253.716 " fill="none" id="cc_rw-to-cc_r_tc_r" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="806.628,250.908,806.4584,256.8149,807.7672,253.6833,810.8988,254.9921,806.628,250.908" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="43.8" x="833.7" y="281.141">sent to cc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="84.6" x="813.3" y="290.3273">wait to receive from tc</text><!--MD5=[8b55405d6f924dfa9de157c44be31672]
link cc_w_tc_w to cc_rw--><path d="M753.54,395.838 C760.002,391.008 766.158,385.038 770.1,378 C775.836,367.77 776.994,354.6 776.736,344.082 " fill="none" id="cc_w_tc_w-to-cc_rw" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="776.616,340.914,774.4181,346.3994,776.7274,343.9119,779.2148,346.2212,776.616,340.914" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="42.6" x="797.7" y="366.941">sent to tc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="85.8" x="776.1" y="376.1273">wait to receive from cc</text><!--MD5=[dd82bd7861c845e608a810b44161b998]
link cc_rw to cc_w_tc_w--><path d="M715.59,340.806 C707.502,345.294 700.23,351.156 695.1,358.8 C687.474,370.164 695.67,383.388 705.57,393.642 " fill="none" id="cc_rw-to-cc_w_tc_w" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="707.838,395.916,705.7167,390.4006,705.7167,393.7947,702.3226,393.7947,707.838,395.916" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="69" x="695.7" y="366.941">received from cc /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="66" x="697.2" y="376.1273">wait to send to tc</text><!--MD5=[3e2edbfafcc8ceeae5e5c966bb4a4ec5]
link connecting to cc_w_tc_w--><path d="M78.228,255.012 C63.804,278.094 45.486,316.992 66.9,340.8 C103.41,381.39 447.87,400.206 623.856,407.232 " fill="none" id="connecting-to-cc_w_tc_w" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="626.952,407.352,621.6522,404.7381,623.9544,407.2321,621.4604,409.5343,626.952,407.352" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="55.2" x="137.7" y="319.541">tc connected /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="162" x="85.5" y="328.7273">send 200 Connection Established to client;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="193.2" x="69.9" y="337.9137">any bytes read from client after CONNECT to target</text><!--MD5=[aec1bc9d83fa0a888b65e2c9853d747d]
link tunneling to *end--><path d="M607.2486,147.3499 C607.1557,147.3736 607.0616,147.3977 606.9664,147.4222 C603.9184,148.2048 599.6602,149.3361 594.4439,150.8186 C584.0113,153.7838 569.7461,158.154 553.6643,163.95 C521.5005,175.542 482.07,192.837 451.5,216 C433.674,229.506 437.148,241.008 419.7,255 C376.068,289.998 312.078,314.07 289.104,322.026 " fill="none" id="tunneling-to-*end" style="stroke:#A80036;stroke-width:0.6;"/><polygon fill="#A80036" points="286.02,323.082,291.9072,323.5927,288.8565,322.1051,290.3441,319.0544,286.02,323.082" style="stroke:#A80036;stroke-width:0.6;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="164.4" x="452.1" y="234.041">either cc or tc is closed by the other party /</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacing" textLength="56.4" x="507.3" y="243.2273">close cc and tc</text><rect fill="#DDDDDD" height="25.7859" rx="3" ry="3" style="stroke:#000000;stroke-width:0.6;" width="305.4" x="368.55" y="452.4"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="267" x="372.15" y="463.5211">cc (client connection) - TCP connection between client and proxy</text><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacing" textLength="298.2" x="372.15" y="473.4141">tc (target connection) - TCP connection between proxy and target server</text><!--MD5=[6ef4448da604b5ff8bf7333b5f44f759]
@startuml

legend
cc (client connection) - TCP connection between client and proxy
tc (target connection) - TCP connection between proxy and target server
end legend

[*] - -> accepted : incoming cc /\n accept cc

accepted : read HTTP CONNECT message

accepted - -> connecting : received valid CONNECT message /\nstart tc
accepted - -> [*] : received invalid CONNECT message ||\n cc closed by client /\nclose cc

connecting : resolve the target hostname to IP address and \n try to establish TCP connection to target

connecting - -> [*] : failed to connect to target /\nsend 404 response to client and close cc

state tunneling {

    tunneling : reading from cc and writing to tc shares the same buffer
    tunneling : reading from tc and writing to cc shares the same buffer
    tunneling : if we're waiting to write to cc, don't read from tc
    tunneling : if we're waiting to write to tc, don't read from cc

    tc_rw : epoll_wait on [tc (waiting to receive and send)]
    cc_r_tc_r : epoll_wait on [cc(waiting to receive), tc (waiting to receive)]
    cc_w_tc_w : epoll_wait on [cc(waiting to send), tc (waiting to send)]
    cc_rw : epoll_wait on [cc (waiting to receive and send)]

    tc_rw - -> cc_r_tc_r : sent to tc /\nwait to receive from cc
    tc_rw - -> cc_w_tc_w : received from tc /\nwait to send to cc

    cc_r_tc_r - -> tc_rw : received from cc /\nwait to send to tc
    cc_r_tc_r - -> cc_rw : received from tc /\nwait to send to cc

    cc_w_tc_w - -> tc_rw : sent to cc /\nwait to receive from tc
    cc_w_tc_w - -> cc_rw : sent to tc /\nwait to receive from cc

    cc_rw - -> cc_r_tc_r: sent to cc /\nwait to receive from tc
    cc_rw - -> cc_w_tc_w: received from cc /\nwait to send to tc
}

connecting - - -> cc_w_tc_w : tc connected /\n send 200 Connection Established to client;\n any bytes read from client after CONNECT to target

tunneling - -> [*] : either cc or tc is closed by the other party /\n close cc and tc

@enduml

PlantUML version 1.2021.11(Sat Oct 02 21:26:11 SGT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: GB
--></g></svg>