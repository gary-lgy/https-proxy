<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="993.6px" preserveAspectRatio="none" style="width:1164px;height:993px;background:#FFFFFF;" version="1.1" viewBox="0 0 1164 993" width="1164.8px" zoomAndPan="magnify"><defs><filter height="300%" id="f829e3du6qwg9" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="1.6000000000000003"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="3.2000000000000006" dy="3.2000000000000006" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[e8cf60533062ab1168b9330d662638e5]
cluster tunneling--><rect fill="#FEFECE" filter="url(#f829e3du6qwg9)" height="487.2" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.2000000000000002;" width="445.6" x="710" y="444.8"/><rect fill="#FFFFFF" height="411.9844" rx="10" ry="10" style="stroke:#FFFFFF;stroke-width:0.8000000000000002;" width="440.8" x="712.4" y="517.6156"/><line style="stroke:#A80036;stroke-width:1.2000000000000002;" x1="710" x2="1155.6" y1="515.2156" y2="515.2156"/><line style="stroke:#A80036;stroke-width:1.2000000000000002;" x1="710" x2="1155.6" y1="465.9906" y2="465.9906"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacing" textLength="52.8" x="802.4" y="458.8281">tunneling</text><text fill="#000000" font-family="sans-serif" font-size="9.6" lengthAdjust="spacing" textLength="260.8" x="714" y="477.2719">reading from cc and writing to tc shares the same buffer</text><text fill="#000000" font-family="sans-serif" font-size="9.6" lengthAdjust="spacing" textLength="260.8" x="714" y="488.5781">reading from tc and writing to cc shares the same buffer</text><text fill="#000000" font-family="sans-serif" font-size="9.6" lengthAdjust="spacing" textLength="221.6" x="714" y="499.8844">if we're waiting to write to cc, don't read from tc</text><text fill="#000000" font-family="sans-serif" font-size="9.6" lengthAdjust="spacing" textLength="221.6" x="714" y="511.1906">if we're waiting to write to tc, don't read from cc</text><g id="tunneling.tc_rw"><rect fill="#FEFECE" filter="url(#f829e3du6qwg9)" height="40.4969" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.2000000000000002;" width="218.4" x="792" y="528.8"/><line style="stroke:#A80036;stroke-width:1.2000000000000002;" x1="792" x2="1010.4" y1="549.9906" y2="549.9906"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacing" textLength="28.8" x="886.8" y="543.6281">tc_rw</text><text fill="#000000" font-family="sans-serif" font-size="9.6" lengthAdjust="spacing" textLength="202.4" x="796" y="563.2719">epoll_wait on [tc (waiting to read and write)]</text></g><g id="tunneling.cc_r_tc_r"><rect fill="#FEFECE" filter="url(#f829e3du6qwg9)" height="40.4969" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.2000000000000002;" width="263.2" x="784.8" y="643.2"/><line style="stroke:#A80036;stroke-width:1.2000000000000002;" x1="784.8" x2="1048" y1="664.3906" y2="664.3906"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacing" textLength="47.2" x="892.8" y="658.0281">cc_r_tc_r</text><text fill="#000000" font-family="sans-serif" font-size="9.6" lengthAdjust="spacing" textLength="247.2" x="788.8" y="677.6719">epoll_wait on [cc(waiting to read), tc (waiting to read)]</text></g><g id="tunneling.cc_w_tc_w"><rect fill="#FEFECE" filter="url(#f829e3du6qwg9)" height="40.4969" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.2000000000000002;" width="264.8" x="760" y="872"/><line style="stroke:#A80036;stroke-width:1.2000000000000002;" x1="760" x2="1024.8" y1="893.1906" y2="893.1906"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacing" textLength="55.2" x="864.8" y="886.8281">cc_w_tc_w</text><text fill="#000000" font-family="sans-serif" font-size="9.6" lengthAdjust="spacing" textLength="248.8" x="764" y="906.4719">epoll_wait on [cc(waiting to write), tc (waiting to write)]</text></g><g id="tunneling.cc_rw"><rect fill="#FEFECE" filter="url(#f829e3du6qwg9)" height="40.4969" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.2000000000000002;" width="220" x="807.2" y="757.6"/><line style="stroke:#A80036;stroke-width:1.2000000000000002;" x1="807.2" x2="1027.2" y1="778.7906" y2="778.7906"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacing" textLength="30.4" x="902" y="772.4281">cc_rw</text><text fill="#000000" font-family="sans-serif" font-size="9.6" lengthAdjust="spacing" textLength="204" x="811.2" y="792.0719">epoll_wait on [cc (waiting to read and write)]</text></g><ellipse cx="122.8" cy="12.8" fill="#000000" filter="url(#f829e3du6qwg9)" rx="8" ry="8" style="stroke:none;stroke-width:0.8000000000000002;"/><g id="accepted"><rect fill="#FEFECE" filter="url(#f829e3du6qwg9)" height="40.4969" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.2000000000000002;" width="234.4" x="5.6" y="94.4"/><line style="stroke:#A80036;stroke-width:1.2000000000000002;" x1="5.6" x2="240" y1="115.5906" y2="115.5906"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacing" textLength="48.8" x="98.4" y="109.2281">accepted</text><text fill="#000000" font-family="sans-serif" font-size="9.6" lengthAdjust="spacing" textLength="218.4" x="9.6" y="128.8719">epoll_wait on [cc (for reading HTTP CONNECT)]</text></g><g id="connecting"><rect fill="#FEFECE" filter="url(#f829e3du6qwg9)" height="40.4969" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.2000000000000002;" width="382.4" x="208.4" y="208.8"/><line style="stroke:#A80036;stroke-width:1.2000000000000002;" x1="208.4" x2="590.8" y1="229.9906" y2="229.9906"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacing" textLength="60.8" x="369.2" y="223.6281">connecting</text><text fill="#000000" font-family="sans-serif" font-size="9.6" lengthAdjust="spacing" textLength="366.4" x="212.4" y="243.2719">epoll_wait on [tc (for successful TCP connection) cc (in case the client closes cc)]</text></g><ellipse cx="459.6" cy="549.2" filter="url(#f829e3du6qwg9)" rx="8" ry="8" style="stroke:#000000;stroke-width:0.8000000000000002;fill:none;"/><ellipse cx="460" cy="549.6" fill="#000000" rx="4.8" ry="4.8" style="stroke:none;stroke-width:0.8000000000000002;"/><g id="connected"><rect fill="#FEFECE" filter="url(#f829e3du6qwg9)" height="40.4969" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.2000000000000002;" width="397.6" x="702.4" y="335.2"/><line style="stroke:#A80036;stroke-width:1.2000000000000002;" x1="702.4" x2="1100" y1="356.3906" y2="356.3906"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacing" textLength="56.8" x="872.8" y="350.0281">connected</text><text fill="#000000" font-family="sans-serif" font-size="9.6" lengthAdjust="spacing" textLength="381.6" x="706.4" y="369.6719">epoll_wait on [cc (for sending 200 OK to client) and tc (in case the client closes cc)]</text></g><!--MD5=[e5609a6cce1cd3a9664f944443c75270]
link *start to accepted--><path d="M122.8,20.824 C122.8,35.128 122.8,67.64 122.8,90.208 " fill="none" id="*start-to-accepted" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="122.8,94.296,126,87.096,122.8,90.296,119.6,87.096,122.8,94.296" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="70.4" x="123.6" y="55.6547">incoming cc /</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="47.2" x="136.8" y="67.9031">accept cc</text><!--MD5=[c7cece667dbf2aa587436eaeeff5188e]
link accepted to connecting--><path d="M171.016,135.248 C220.376,155.368 296.856,186.528 347.568,207.192 " fill="none" id="accepted-to-connecting" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="351.472,208.784,346.0115,203.104,347.7676,207.2748,343.5968,209.031,351.472,208.784" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="178.4" x="286.8" y="170.0547">received valid CONNECT message /</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="36" x="358" y="182.3031">start tc</text><!--MD5=[c80d2ccf554935d64daf6cf72cd3822a]
link accepted to *end--><path d="M119.552,135.456 C114.504,172.624 108.4,254.088 140.4,311.2 C215.424,445.088 400.832,525.304 448.36,544.112 " fill="none" id="accepted-to-*end" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="452.28,545.64,446.7476,540.0299,448.5567,544.1781,444.4086,545.9872,452.28,545.64" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="190.4" x="141.2" y="284.4547">received invalid CONNECT message ||</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="102.4" x="186.8" y="296.7031">cc closed by client /</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="40.8" x="216" y="308.9516">close cc</text><!--MD5=[9b22ae083a3552991478e4fc76f82837]
link connecting to *end--><path d="M379.728,249.704 C354.52,277.208 316.064,329.008 331.6,376 C356.128,450.184 426.288,518.456 450.92,540.768 " fill="none" id="connecting-to-*end" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="453.96,543.496,450.749,536.3009,450.9868,540.8201,446.4676,541.058,453.96,543.496" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="99.2" x="332.4" y="353.6547">cc closed by client/</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="40.8" x="361.6" y="365.9031">close cc</text><!--MD5=[9b22ae083a3552991478e4fc76f82837]
link connecting to *end--><path d="M407.824,249.792 C416.152,270.664 428.744,304.688 435.6,335.2 C452.56,410.712 457.8,504.096 459.168,536.592 " fill="none" id="connecting-to-*end-1" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="459.344,540.936,462.2537,533.6139,459.1841,536.9392,455.8588,533.8697,459.344,540.936" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="140" x="477.2" y="353.6547">failed to connect to target /</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="205.6" x="444.4" y="365.9031">send 404 response to client and close cc</text><!--MD5=[171f9586bb7321f97d59c962b0299183]
link connecting to connected--><path d="M478.528,249.64 C571.184,272.688 724.144,310.752 818.432,334.208 " fill="none" id="connecting-to-connected" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="822.32,335.176,816.0977,330.3425,818.4368,334.2166,814.5627,336.5557,822.32,335.176" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="64.8" x="725.2" y="296.4547">tc connected</text><!--MD5=[1b773ae45b1a18ba2a54878a71ea9ae0]
link connected to *end--><path d="M707.632,376.072 C683.32,382.08 659.264,389.888 637.2,400 C560.296,435.256 489.76,512.904 467.136,539.36 " fill="none" id="connected-to-*end" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="464.384,542.608,471.4856,539.1953,466.9749,539.5605,466.6097,535.0498,464.384,542.608" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="256" x="638" y="410.8547">sending 200 response failed || tc closed by target/</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="75.2" x="728.4" y="423.1031">close cc and tc</text><!--MD5=[f43231d6eb4c16971912ee5b2b7f438a]
link tc_rw to cc_r_tc_r--><path d="M875.096,569.816 C868.216,576.528 861.688,584.632 858,593.6 C853.672,604.12 852.904,609.032 858,619.2 C862.168,627.512 868.76,634.648 876.032,640.592 " fill="none" id="tc_rw-to-cc_r_tc_r" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="879.184,643.072,875.4862,636.1146,876.034,640.6068,871.5418,641.1546,879.184,643.072" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="63.2" x="858.8" y="604.4547">wrote to tc /</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="63.2" x="858.8" y="616.7031">read from cc</text><!--MD5=[4428c1322e23cc1a099bebe13dfae057]
link cc_r_tc_r to tc_rw--><path d="M923.2,643.16 C927.064,629.176 930.344,610.016 926,593.6 C924.176,586.696 920.976,579.744 917.464,573.48 " fill="none" id="cc_r_tc_r-to-tc_rw" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="915.256,569.68,916.1053,577.5132,917.2651,573.1388,921.6394,574.2986,915.256,569.68" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="72" x="928.4" y="604.4547">read from cc /</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="51.2" x="938.8" y="616.7031">write to tc</text><!--MD5=[b42f2a74911ad0d1a348098e63590620]
link tc_rw to cc_w_tc_w--><path d="M854.168,569.72 C824.36,584.992 788.24,609.304 770.8,643.2 C753.168,677.472 776.176,763.192 793.2,798.4 C807.512,828.008 835.576,852.96 858.216,869.576 " fill="none" id="tc_rw-to-cc_w_tc_w" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="861.512,871.968,857.5741,865.1436,858.278,869.614,853.8076,870.3179,861.512,871.968" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="70.4" x="771.6" y="718.8547">read from tc /</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="52.8" x="780.4" y="731.1031">write to cc</text><!--MD5=[9220513ff5ada1a62067df3928ffe9ae]
link cc_w_tc_w to tc_rw--><path d="M955.192,872 C970.496,865.664 986.28,857.704 999.6,848 C1062.632,802.08 1055,761.672 1062,684 C1063.632,665.936 1069.32,659.792 1062,643.2 C1048.784,613.272 1035.248,611.096 1007.6,593.6 C993.992,584.992 978.392,577.48 963.416,571.224 " fill="none" id="cc_w_tc_w-to-tc_rw" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="959.624,569.664,965.0482,575.3787,963.3187,571.1968,967.5006,569.4673,959.624,569.664" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="64.8" x="1060.4" y="718.8547">wrote to cc /</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="61.6" x="1062" y="731.1031">read from tc</text><!--MD5=[6f70bdb54283637e828b9a914e2682b4]
link cc_r_tc_r to cc_rw--><path d="M884.76,684.032 C876.904,690.608 869.512,698.672 865.2,708 C860.432,718.328 860.392,723.288 865.2,733.6 C868.928,741.584 874.912,748.624 881.512,754.584 " fill="none" id="cc_r_tc_r-to-cc_rw" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="884.8,757.432,881.4446,750.3031,881.7735,754.8166,877.26,755.1455,884.8,757.432" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="70.4" x="866" y="718.8547">read from tc /</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="52.8" x="874.8" y="731.1031">write to cc</text><!--MD5=[866f797d1bf0a28ccbbe384663f129fd]
link cc_rw to cc_r_tc_r--><path d="M930.36,757.408 C934.408,750.224 938.344,741.84 940.4,733.6 C943.152,722.56 943.232,719.016 940.4,708 C938.64,701.136 935.544,694.2 932.144,687.936 " fill="none" id="cc_rw-to-cc_r_tc_r" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="930.008,684.136,930.7378,691.9812,931.9642,687.625,936.3203,688.8514,930.008,684.136" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="64.8" x="942.8" y="718.8547">wrote to cc /</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="61.6" x="944.4" y="731.1031">read from tc</text><!--MD5=[8b55405d6f924dfa9de157c44be31672]
link cc_w_tc_w to cc_rw--><path d="M911.904,871.976 C917.576,864.984 923.04,856.688 926,848 C930.952,833.456 928.84,816.328 925.44,802.752 " fill="none" id="cc_w_tc_w-to-cc_rw" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="924.352,798.664,923.1124,806.445,925.3812,802.5293,929.2969,804.7982,924.352,798.664" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="63.2" x="929.2" y="833.2547">wrote to tc /</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="63.2" x="929.2" y="845.5031">read from cc</text><!--MD5=[dd82bd7861c845e608a810b44161b998]
link cc_rw to cc_w_tc_w--><path d="M869.816,798.416 C860.296,804.64 851.528,812.536 846,822.4 C840.44,832.328 841.48,837.56 846,848 C849.392,855.848 854.976,862.936 861.104,869 " fill="none" id="cc_rw-to-cc_w_tc_w" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="864.152,871.896,861.1458,864.6129,861.2557,869.1371,856.7316,869.247,864.152,871.896" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="72" x="846.8" y="833.2547">read from cc /</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="51.2" x="857.2" y="845.5031">write to tc</text><!--MD5=[a98136701e795c1e1676cc832b0201ed]
link connected to tc_rw--><path d="M901.2,376.224 C901.2,411.816 901.2,486.392 901.2,524.648 " fill="none" id="connected-to-tc_rw" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="901.2,528.68,904.4,521.48,901.2,524.68,898,521.48,901.2,528.68" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="176" x="921.6" y="410.8547">sending 200 response succeeded /</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="215.2" x="902" y="423.1031">send the bytes right after CONNECT, if any</text><!--MD5=[aec1bc9d83fa0a888b65e2c9853d747d]
link tunneling to *end--><path d="M709.626,549.2 C709.4774,549.2 709.3266,549.2 709.1735,549.2 C707.9488,549.2 706.5805,549.2 705.0781,549.2 C699.0688,549.2 690.9146,549.2 681.2231,549.2 C661.8403,549.2 636.3085,549.2 609.489,549.2 C555.85,549.2 497.06,549.2 472.008,549.2 " fill="none" id="tunneling-to-*end" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><polygon fill="#A80036" points="467.856,549.2,475.056,552.4,471.856,549.2,475.056,546,467.856,549.2" style="stroke:#A80036;stroke-width:0.8000000000000002;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="219.2" x="482.256" y="532.0547">either cc or tc is closed by the other party /</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacing" textLength="75.2" x="555.856" y="544.3031">close cc and tc</text><rect fill="#DDDDDD" height="34.3813" rx="4" ry="4" style="stroke:#000000;stroke-width:0.8000000000000002;" width="407.2" x="373.4" y="947.2"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacing" textLength="356" x="378.2" y="962.0281">cc (client connection) - TCP connection between client and proxy</text><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacing" textLength="397.6" x="378.2" y="975.2188">tc (target connection) - TCP connection between proxy and target server</text><!--MD5=[f1882dd313a2275c1cf63076d668bb76]
@startuml

legend
cc (client connection) - TCP connection between client and proxy
tc (target connection) - TCP connection between proxy and target server
end legend

[*] - -> accepted : incoming cc /\n accept cc

accepted : epoll_wait on [cc (for reading HTTP CONNECT)]

accepted - -> connecting : received valid CONNECT message /\nstart tc
accepted - -> [*] : received invalid CONNECT message ||\n cc closed by client /\nclose cc

connecting : epoll_wait on [tc (for successful TCP connection) cc (in case the client closes cc)]

connecting - -> [*] : cc closed by client/\nclose cc
connecting - -> [*] : failed to connect to target /\nsend 404 response to client and close cc

connecting - -> connected : tc connected

connected : epoll_wait on [cc (for sending 200 OK to client) and tc (in case the client closes cc)]

connected - -> [*] : sending 200 response failed || tc closed by target/\nclose cc and tc

state tunneling {

    tunneling : reading from cc and writing to tc shares the same buffer
    tunneling : reading from tc and writing to cc shares the same buffer
    tunneling : if we're waiting to write to cc, don't read from tc
    tunneling : if we're waiting to write to tc, don't read from cc

    tc_rw : epoll_wait on [tc (waiting to read and write)]
    cc_r_tc_r : epoll_wait on [cc(waiting to read), tc (waiting to read)]
    cc_w_tc_w : epoll_wait on [cc(waiting to write), tc (waiting to write)]
    cc_rw : epoll_wait on [cc (waiting to read and write)]

    tc_rw - -> cc_r_tc_r : wrote to tc /\nread from cc
    tc_rw - -> cc_w_tc_w : read from tc /\nwrite to cc

    cc_r_tc_r - -> tc_rw : read from cc /\nwrite to tc
    cc_r_tc_r - -> cc_rw : read from tc /\nwrite to cc

    cc_w_tc_w - -> tc_rw : wrote to cc /\nread from tc
    cc_w_tc_w - -> cc_rw : wrote to tc /\nread from cc

    cc_rw - -> cc_r_tc_r: wrote to cc /\nread from tc
    cc_rw - -> cc_w_tc_w: read from cc /\nwrite to tc
}

connected - -> tc_rw : sending 200 response succeeded /\nsend the bytes right after CONNECT, if any

tunneling -> [*] : either cc or tc is closed by the other party /\n close cc and tc

@enduml

PlantUML version 1.2021.11(Sat Oct 02 21:26:11 SGT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: GB
--></g></svg>